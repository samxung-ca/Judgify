<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Judgify - Hackathon Scoring Dashboard</title>
    <style>
        :root {
            --bg: #0f1220; --card: #151933; --muted: #aab1d6; --text: #e8ebff;
            --accent: #6aa6ff; --accent2: #8ef0d1; --border: #2a2f55; 
            --bad: #ff6b6b; --ok: #7CFC98; --warn: #ffb86b;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }
        h1 {
            color: var(--accent);
            margin-bottom: 10px;
        }
        .subtitle {
            color: var(--muted);
            font-size: 16px;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        @media (max-width: 1024px) {
            .grid { grid-template-columns: 1fr; }
        }
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        .card h2 {
            margin-bottom: 15px;
            color: var(--accent);
            font-size: 18px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: var(--muted);
            font-size: 14px;
        }
        input, textarea, select {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
        }
        textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }
        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn:hover {
            background: #5a95ff;
            transform: translateY(-1px);
        }
        .btn:active {
            transform: translateY(0);
        }
        .btn-success {
            background: var(--accent2);
            color: #000;
        }
        .btn-warning {
            background: var(--warn);
            color: #000;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .score-display {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, var(--card), #1a1f3c);
            border-radius: 12px;
            margin: 20px 0;
        }
        .score {
            font-size: 48px;
            font-weight: 800;
            background: linear-gradient(90deg, var(--accent), var(--accent2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .results-table th {
            color: var(--muted);
            font-weight: 600;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 14px;
        }
        .status.info {
            background: rgba(106, 166, 255, 0.1);
            border-left: 4px solid var(--accent);
        }
        .status.success {
            background: rgba(124, 252, 152, 0.1);
            border-left: 4px solid var(--ok);
        }
        .status.error {
            background: rgba(255, 107, 107, 0.1);
            border-left: 4px solid var(--bad);
        }
        .help-text {
            color: var(--muted);
            font-size: 12px;
            margin-top: 5px;
        }
        .rubric-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 6px;
            margin: 5px 0;
            border-left: 3px solid var(--accent);
        }
        .project-list {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
        }
        .project-item {
            padding: 15px;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }
        .project-item:hover {
            border-color: var(--accent);
            background: rgba(106, 166, 255, 0.1);
        }
        .project-item.selected {
            border-color: var(--accent2);
            background: rgba(142, 240, 209, 0.1);
        }
        .project-rank {
            font-weight: bold;
            color: var(--accent);
            margin-right: 10px;
        }
        .project-score {
            float: right;
            font-weight: bold;
            color: var(--accent2);
        }
        .project-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        .project-links {
            font-size: 12px;
            color: var(--muted);
            margin-top: 5px;
        }
        .ranking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚ú® Judgify ‚ú®- Hackathon Scoring Dashboard</h1>
            <p class="subtitle">Automatically score all hackathon submissions from a gallery link</p>
        </header>

        <div class="grid">
            <!-- Left Column -->
            <div>
                <!-- Rubric Setup -->
                <div class="card">
                    <h2>üìã Judging Rubric</h2>
                    <div class="form-group">
                        <label>Upload Rubric PDF</label>
                        <input type="file" id="pdfUpload" accept="application/pdf">
                        <div class="help-text">Upload your judging criteria PDF</div>
                    </div>
                    <div class="btn-group">
                        <button class="btn" onclick="extractRubric()">
                            üß† Submit PDF
                        </button>
                    </div>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label>Or Use Manual Rubric (JSON)</label>
                        <textarea id="manualRubric" placeholder='[{"name":"Impact","weight":0.3,"max":10},{"name":"Technical","weight":0.4,"max":10},{"name":"Design","weight":0.3,"max":10}]' rows="4"></textarea>
                    </div>
                    <button class="btn" onclick="loadManualRubric()">üìù Load Manual Rubric</button>
                    
                    <div id="extractStatus"></div>
                </div>

                <!-- Hackathon Gallery -->
                <div class="card">
                    <h2>üöÄ Hackathon Submissions</h2>
                    <div class="form-group">
                        <label for="galleryUrl">Hackathon Gallery URL</label>
                        <input type="url" id="galleryUrl" placeholder="https://devpost.com/software/hackathon-name">
                        <div class="help-text">Paste the main hackathon submissions gallery URL</div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="scoreAllProjects()">
                            ‚ö° Score All Submissions
                        </button>
                    </div>
                    <div id="galleryStatus"></div>
                </div>

                <!-- Current Rubric Display -->
                <div class="card">
                    <h2>üìù Current Rubric</h2>
                    <div id="currentRubricDisplay" style="color: var(--muted); font-size: 14px;">
                        No rubric loaded
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div>
                <!-- Project Rankings -->
                <div class="card">
                    <div class="ranking-header">
                        <h2>üèÜ Project Rankings</h2>
                        <button class="btn" onclick="exportCSV()">üìÑ Export CSV</button>
                    </div>
                    <div class="project-list" id="projectList">
                        <div style="text-align: center; color: var(--muted); padding: 40px;">
                            No projects scored yet. Load a rubric and score submissions to see rankings.
                        </div>
                    </div>
                </div>

                <!-- Selected Project Details -->
                <div class="card">
                    <h2 id="selectedProjectTitle">üìä Mark Breakdown</h2>
                    <div class="score-display">
                        <div class="score" id="totalScore">‚Äî</div>
                        <div style="color: var(--muted);">Overall Score / 10</div>
                    </div>
                    <div id="resultsTable"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===========================
        // CONFIGURATION - HARDCODED API KEY
        // ===========================
        const GEMINI_API_KEY = "AIzaSyAJl-TS5LNVuCjSBRLNM9DrwQZm8h1WdoY"; // API KEY 2
        const GEMINI_MODEL = "gemini-2.5-flash-exp"; // Primary model
        const FALLBACK_MODEL = "gemini-2.0-flash-exp"; // Fallback model

        let currentRubric = [];
        let allProjects = [];
        let selectedProjectIndex = -1;

        // ===========================
        // UTILITY FUNCTIONS
        // ===========================
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function clearStatus(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = btoa(
                        new Uint8Array(reader.result).reduce((data, byte) => data + String.fromCharCode(byte), '')
                    );
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function updateRubricDisplay() {
            const display = document.getElementById('currentRubricDisplay');
            if (currentRubric.length === 0) {
                display.innerHTML = '<div style="color: var(--muted);">No rubric loaded</div>';
                return;
            }

            let html = '<div style="margin-bottom: 10px;"><strong>Loaded Criteria:</strong></div>';
            currentRubric.forEach((criterion, index) => {
                html += `
                    <div class="rubric-item">
                        <div><strong>${criterion.name}</strong></div>
                        <div style="font-size: 12px; color: var(--muted);">Weight: ${(criterion.weight * 100).toFixed(1)}% | Max: ${criterion.max}</div>
                        ${criterion.description ? `<div style="font-size: 11px; margin-top: 4px;">${criterion.description}</div>` : ''}
                    </div>
                `;
            });
            
            const totalWeight = currentRubric.reduce((sum, item) => sum + item.weight, 0);
            html += `<div style="margin-top: 10px; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 4px;">
                        <strong>Total Weight:</strong> ${(totalWeight * 100).toFixed(1)}% | <strong>Criteria:</strong> ${currentRubric.length}
                    </div>`;
            
            display.innerHTML = html;
        }

        // ===========================
        // GEMINI API FUNCTIONS
        // ===========================
        async function callGeminiAPI(prompt, model = GEMINI_MODEL) {
            if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_API_KEY_HERE") {
                throw new Error("API key not configured. Please set your Gemini API key in the code.");
            }

            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`;
            
            const response = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        temperature: 0.1,
                        topP: 0.8,
                        topK: 40,
                        maxOutputTokens: 4096,
                    }
                })
            });

            if (!response.ok) {
                // Try fallback model if primary fails
                if (model === GEMINI_MODEL && FALLBACK_MODEL) {
                    console.log(`Primary model failed, trying fallback: ${FALLBACK_MODEL}`);
                    return await callGeminiAPI(prompt, FALLBACK_MODEL);
                }
                
                const errorText = await response.text();
                throw new Error(`API Error ${response.status}: ${errorText.substring(0, 200)}`);
            }

            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        // ===========================
        // RUBRIC EXTRACTION
        // ===========================
        async function extractRubric() {
            const fileInput = document.getElementById('pdfUpload');
            const file = fileInput.files[0];
            
            if (!file) {
                showStatus('extractStatus', 'Please select a PDF file first', 'error');
                return;
            }

            showStatus('extractStatus', 'Analyzing PDF and extracting criteria...', 'info');

            try {
                const base64 = await fileToBase64(file);
                
                const prompt = `Extract judging rubric from PDF. Return ONLY JSON array:

[
  {
    "name": "Criterion Name",
    "weight": 0.35,
    "max": 10,
    "description": "Description"
  }
]

Rules:
- Weights must sum to 1.0
- Return ONLY JSON, no other text`;

                const response = await callGeminiAPI(prompt);
                
                const jsonMatch = response.match(/\[[\s\S]*\]/);
                if (!jsonMatch) {
                    throw new Error('No valid rubric found in PDF');
                }

                currentRubric = JSON.parse(jsonMatch[0]);
                
                // Normalize weights
                const weightSum = currentRubric.reduce((sum, item) => sum + (item.weight || 0), 0);
                if (weightSum === 0 || Math.abs(weightSum - 1.0) > 0.01) {
                    const equalWeight = 1.0 / currentRubric.length;
                    currentRubric = currentRubric.map(item => ({
                        name: item.name || `Criterion ${currentRubric.indexOf(item) + 1}`,
                        weight: equalWeight,
                        max: item.max || 10,
                        description: item.description || item.name
                    }));
                }

                showStatus('extractStatus', `‚úÖ Extracted ${currentRubric.length} criteria!`, 'success');
                updateRubricDisplay();
                
            } catch (error) {
                showStatus('extractStatus', `‚ùå Extraction failed: ${error.message}`, 'error');
            }
        }

        function loadManualRubric() {
            try {
                const manualInput = document.getElementById('manualRubric').value.trim();
                if (!manualInput) {
                    showStatus('extractStatus', 'Please enter rubric JSON', 'error');
                    return;
                }

                currentRubric = JSON.parse(manualInput);
                
                if (!Array.isArray(currentRubric) || currentRubric.length === 0) {
                    throw new Error('Rubric must be a non-empty JSON array');
                }

                // Normalize weights
                const weightSum = currentRubric.reduce((sum, item) => sum + (item.weight || 0), 0);
                if (weightSum === 0 || Math.abs(weightSum - 1.0) > 0.01) {
                    const equalWeight = 1.0 / currentRubric.length;
                    currentRubric = currentRubric.map(item => ({
                        name: item.name || `Criterion ${currentRubric.indexOf(item) + 1}`,
                        weight: equalWeight,
                        max: item.max || 10,
                        description: item.description || item.name
                    }));
                }

                showStatus('extractStatus', `‚úÖ Loaded ${currentRubric.length} criteria!`, 'success');
                updateRubricDisplay();
                
            } catch (error) {
                showStatus('extractStatus', `‚ùå Invalid JSON: ${error.message}`, 'error');
            }
        }

        // ===========================
        // PROJECT SCORING
        // ===========================
        async function scoreAllProjects() {
            const galleryUrl = document.getElementById('galleryUrl').value.trim();
            
            if (currentRubric.length === 0) {
                showStatus('galleryStatus', 'Please load a rubric first', 'error');
                return;
            }
            
            if (!galleryUrl) {
                showStatus('galleryStatus', 'Please enter a hackathon gallery URL', 'error');
                return;
            }

            showStatus('galleryStatus', 'üîÑ Discovering and scoring submissions... This may take several minutes.', 'info');

            try {
                // First, extract project links from the gallery
                const projects = await extractProjectsFromGallery(galleryUrl);
                
                if (projects.length === 0) {
                    throw new Error('No projects found in the gallery');
                }

                showStatus('galleryStatus', `üìä Found ${projects.length} projects. Starting AI evaluation...`, 'info');

                // Score each project
                allProjects = [];
                for (let i = 0; i < projects.length; i++) {
                    const project = projects[i];
                    showStatus('galleryStatus', `üß† Scoring project ${i + 1}/${projects.length}: ${project.title}`, 'info');
                    
                    try {
                        const scoredProject = await scoreSingleProject(project);
                        allProjects.push(scoredProject);
                        
                        // Update rankings after each project
                        updateProjectRankings();
                    } catch (error) {
                        console.error(`Failed to score project ${project.title}:`, error);
                        // Continue with other projects even if one fails
                    }
                }

                showStatus('galleryStatus', `‚úÖ Successfully scored ${allProjects.length}/${projects.length} projects!`, 'success');
                updateProjectRankings();
                
            } catch (error) {
                showStatus('galleryStatus', `‚ùå Scoring failed: ${error.message}`, 'error');
            }
        }

        async function extractProjectsFromGallery(galleryUrl) {
            // This is a simplified version - in reality, you'd need to handle
            // the specific structure of the hackathon platform
            const prompt = `EXTRACT HACKATHON PROJECTS FROM GALLERY:

Gallery URL: ${galleryUrl}

Return ONLY JSON array of projects:
[
  {
    "title": "Project Name",
    "url": "https://devpost.com/software/project-name",
    "description": "Brief description",
    "technologies": ["tech1", "tech2"],
    "demoUrl": "https://youtube.com/demo",
    "codeUrl": "https://github.com/repo"
  }
]

Extract ALL visible projects from the gallery. Return ONLY JSON.`;

            const response = await callGeminiAPI(prompt);
            const jsonMatch = response.match(/\[[\s\S]*\]/);
            
            if (!jsonMatch) {
                throw new Error('Could not extract projects from gallery');
            }

            return JSON.parse(jsonMatch[0]);
        }

        async function scoreSingleProject(project) {
            const prompt = `ACT AS HACKATHON JUDGE:

PROJECT TO EVALUATE:
Title: ${project.title}
Description: ${project.description}
Technologies: ${project.technologies?.join(', ') || 'Not specified'}
Demo: ${project.demoUrl || 'Not provided'}
Code: ${project.codeUrl || 'Not provided'}

RUBRIC CRITERIA:
${JSON.stringify(currentRubric, null, 2)}

Evaluate this project against each criterion and return ONLY JSON:
{
  "totalScore": 8.2,
  "criteria": [
    {
      "name": "Criterion Name",
      "score": 7.5,
      "weight": 0.35,
      "max": 10,
      "reason": "Specific feedback",
      "weightedScore": 2.63
    }
  ]
}

Rules:
- Score 0-max for each criterion
- weightedScore = score * weight
- totalScore = sum(weightedScore)
- Be fair but critical
- Return ONLY JSON`;

            const response = await callGeminiAPI(prompt);
            const jsonMatch = response.match(/\{[\s\S]*\}/);
            
            if (!jsonMatch) {
                throw new Error('Invalid scoring response');
            }

            const results = JSON.parse(jsonMatch[0]);
            
            return {
                ...project,
                score: results.totalScore || results.criteria?.reduce((sum, c) => sum + (c.weightedScore || 0), 0) || 0,
                criteria: results.criteria || [],
                totalScore: results.totalScore || 0
            };
        }

        // ===========================
        // UI UPDATES
        // ===========================
        function updateProjectRankings() {
            const projectList = document.getElementById('projectList');
            
            if (allProjects.length === 0) {
                projectList.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 40px;">No projects scored yet.</div>';
                return;
            }

            // Sort projects by score (descending)
            const sortedProjects = [...allProjects].sort((a, b) => b.score - a.score);
            
            let html = '';
            sortedProjects.forEach((project, index) => {
                const isSelected = selectedProjectIndex === sortedProjects.indexOf(project);
                html += `
                    <div class="project-item ${isSelected ? 'selected' : ''}" onclick="selectProject(${sortedProjects.indexOf(project)})">
                        <div class="project-rank">#${index + 1}</div>
                        <div class="project-score">${project.score.toFixed(1)}</div>
                        <div class="project-title">${project.title}</div>
                        <div class="project-links">
                            ${project.technologies?.slice(0, 3).join(' ‚Ä¢ ') || 'No tech specified'}
                        </div>
                    </div>
                `;
            });
            
            projectList.innerHTML = html;
            
            // Auto-select first project if none selected
            if (selectedProjectIndex === -1 && sortedProjects.length > 0) {
                selectProject(0);
            }
        }

        function selectProject(index) {
            selectedProjectIndex = index;
            const project = allProjects[index];
            
            if (!project) return;

            // Update project title
            document.getElementById('selectedProjectTitle').textContent = `üìä ${project.title}`;
            
            // Update total score
            document.getElementById('totalScore').textContent = project.score.toFixed(1);
            
            // Update results table
            let tableHTML = `
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Criteria</th>
                            <th>Score</th>
                            <th>Weight</th>
                            <th>Weighted</th>
                            <th>Reason</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            (project.criteria || []).forEach(criterion => {
                tableHTML += `
                    <tr>
                        <td><strong>${criterion.name}</strong></td>
                        <td>${criterion.score}/${criterion.max}</td>
                        <td>${((criterion.weight || 0) * 100).toFixed(1)}%</td>
                        <td><strong>${(criterion.weightedScore || 0).toFixed(2)}</strong></td>
                        <td style="color: var(--muted); font-size: 12px;">${criterion.reason || 'No reason provided'}</td>
                    </tr>
                `;
            });
            
            tableHTML += `</tbody></table>`;
            document.getElementById('resultsTable').innerHTML = tableHTML;
            
            // Update project list selection
            updateProjectRankings();
        }

        // ===========================
        // EXPORT FUNCTIONS
        // ===========================
        function exportCSV() {
            if (allProjects.length === 0) {
                alert('No projects to export');
                return;
            }
            
            const sortedProjects = [...allProjects].sort((a, b) => b.score - a.score);
            
            // Create headers
            const headers = ['Rank', 'Project', 'Total Score'];
            currentRubric.forEach(criterion => {
                headers.push(`${criterion.name} Score`);
                headers.push(`${criterion.name} Reason`);
            });
            
            // Create rows
            const rows = sortedProjects.map((project, index) => {
                const row = [
                    index + 1,
                    project.title,
                    project.score.toFixed(2)
                ];
                
                currentRubric.forEach(criterion => {
                    const projectCriterion = project.criteria?.find(c => c.name === criterion.name);
                    row.push(projectCriterion?.score || 'N/A');
                    row.push((projectCriterion?.reason || 'No reason').replace(/,/g, ';'));
                });
                
                return row;
            });
            
            const csvContent = [headers, ...rows]
                .map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
                .join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `hackathon-scores-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ===========================
        // INITIALIZATION
        // ===========================
        console.log('Judgify Hackathon Dashboard loaded');
        
        // Pre-fill with sample rubric
        document.getElementById('manualRubric').value = JSON.stringify([
            { 
                "name": "Innovation & Creativity", 
                "weight": 0.25, 
                "max": 10, 
                "description": "Originality and novel approach" 
            },
            { 
                "name": "Technical Implementation", 
                "weight": 0.35, 
                "max": 10, 
                "description": "Code quality and technical complexity" 
            },
            { 
                "name": "Impact & Usefulness", 
                "weight": 0.20, 
                "max": 10, 
                "description": "Real-world impact and utility" 
            },
            { 
                "name": "Design & User Experience", 
                "weight": 0.20, 
                "max": 10, 
                "description": "UI/UX design and usability" 
            }
        ], null, 2);
    </script>
</body>
</html>
